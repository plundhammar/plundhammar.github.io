[{"content":"Litterature: Mainly based on:\nVoichita Maxim et al (2016) Probabilistic models and numerical calculation of system matrix and sensitivity in list-mode MLEM 3D reconstruction of Compton camera images Phys.Med.Biol. 61 243\nUncertainty distribution in measurements\nOrdonez et al (1997) Ordonez C E, Bolozdynya A and Chang W 1997 Dependence of angular uncertainties on the energy resolution of Compton cameras IEEE Nuclear Science Symp. vol 2\nLM-MLEM\nWilderman et al (1998) Wilderman S J, Clinthorne N, Fessler J A and Rogers W L 1998a List-mode maximum likelihood reconstruction of Compton scatter camera images in nuclear medicine Nuclear Science Symp. Conf. Rec. 3 1716–20 Dempster et al (1977) Dempster A P, Laird N M and Rubin D B 1977 Maximum likelihood from incomplete data via the EM algorithm J. R. Stat. Soc. B 39 1–38 Lange Carson (1984) Lange K and Carson R 1984 EM reconstruction algorithms for emission and transmission tomography J. Comput. Assist. Tomogr. 8 306–16 Shepp and Vardi (1982) Shepp L and Vardi Y 1982 Maximum likelihood reconstruction for emission tomography IEEE Trans. Med. Imaging 1 113–22\nList-Mode Maximum Likelihood Expectation Maximization (LM-MLEM) Let $\\lambda$ be the mean and variance of the Poisson distribution of some source. The following sequence converges to $\\lambda$:\n$$ \\widehat{\\lambda}_j^{l+1} = \\frac{\\widehat{\\lambda}_j^{(l)}}{s_j}\\sum_{i=1}^N t_{ij}\\frac{1}{p_i^{(l)}} \\text{ with } p_i^{(l)} = \\sum_{k=1}^M t_{ik} \\widehat{\\lambda}^{(l)}_k $$ where\n$t_{ij}$ are elements of the system matrix, indexed on the events $i$ and voxels $j$; $s_j=\\sum_i t_{ij}$is the sensitivity correction. The initialization step consist in calculating $\\widehat{\\lambda}^{(0)}$, generally as the back-projection in the image volume of the $N$ events.\nProbabilistic Model of the System Matrix Let $x$ be the vector of coordinates of a point $M$ from the source. The probability of occurrence of the measured event $y$ given that $\\mathfrak{p}$ was emitted at $x$ is given by the Chapman–Kolmogorov equation \\begin{equation} p_{Y:X}(y:x,E_0) = \\int p_{Y:\\tilde{Y}}(y:\\tilde{y},E_0)p_{\\tilde{Y}:X}(\\tilde{y}:x,E_0)\\textrm{d}\\tilde{y}. \\end{equation} We will now argue for what proberties the two probability distributions\nConsidering $p_{Y:\\tilde{Y}}(y:\\tilde{y},E_0)$, this distribution could be summerized to have the task of answering the following question:\nHow likely is it that the measured event $y$ was registred given that the real event $\\tilde{y}$ happend? Since the measurement is based on the measurement and real event of the position in the first and second scatterer, as well as the measurement and real event of the scattering angle which we may assume to be independent we have\n$$ p_{Y:\\tilde{Y}}(y:\\tilde{y},E_0) =p_{V_1:\\tilde{V}_1}(V_1:\\tilde{V_1},E_0)p_{V_2:\\tilde{V}_2}(V_2:\\tilde{V}_2,E_0)p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta},E_0). $$ The terms $p_{V_i:\\tilde{V}_i}(V_i:\\tilde{V_i},E_0)$ depends on the spatial resolution of the detector and something that we may impose depending on the detector design. The term $p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta},E_0)$ depends on the energy resolution of the detectors, since the measured scattering angle $\\beta$ is calculated through an energy dependent relation (Compton scattering with additional corrections perhaps).\nNow considering $p_{\\tilde{Y}:X}(\\tilde{y}:x,E_0)$, it is the product of several probabilities:\nThe probability of the Compton scattering process (including Doppler-broadening); Absorption probabilities (in the different environments such as the object, air, absorption of the scattered photon in the scatter detector); The absorption probability of the photon in the absorber; The solid angle subtended at the origin of the particle $M$ by the detector element containing the first hit, which should be considered in 3D since the emission is isotropic, and on the solid angle subtended at the position of the first hit by the detector element where the second hit takes place, which should be considered in 2D since it is related to a cone surface uncertainty through the scattering angle. The probability of the Compton scattering process is proportional to the Compton scattering cross-section given by the Klein-Nishima distribution, denoted $K(\\tilde{\\beta}:E_0)$ at energy $E_0$.\nThe absorption probabilities has been discussed previously in\nWilderman et al 1998a Parra 2000 I general a solid angle considered in 3D may be written $A/r^2$ where $A$ is the sector of the sphere of radius $r$ that the half-angle covers. Similarly, in 2D it may be written $A/r$ with the same definition. So, the solid angle subtended at the origin of the particle at $M$ can be written $$ \\frac{1}{\\tilde{V}_1M^2}\\int_{S_{\\tilde{V}_1M}}\\textrm{d}S\\propto \\frac{1}{\\tilde{V}_1M^2}\\int_{-\\theta_{\\tilde{V}_1M^2}}^{\\theta_{\\tilde{V}_1M^2}}\\sin(\\theta)\\textrm{d}\\theta \\propto \\frac{\\cos(\\theta_{\\tilde{V}_1M})}{\\tilde{V}_1M^2}. $$\nSimilarly, the solid angle subtended at the position of the first hit by the detector element where the second hit takes place is proportional to $$ \\frac{\\cos(\\theta_{\\tilde{V}_1\\tilde{V}_2})}{\\tilde{V}_1\\tilde{V}_2}, $$ since we now consider it in 2D.\nIgnoring absorption probabilities, we can now write $$ p_{\\tilde{Y}:X}(\\tilde{y}:x,E_0)\\propto K(\\tilde{\\beta}:E_0)\\frac{\\cos(\\theta_{\\tilde{V}_1M})}{\\tilde{V}_1M^2}\\frac{\\cos(\\theta_{\\tilde{V}_1\\tilde{V}_2})}{\\tilde{V}_1\\tilde{V}_2} $$\nIf the real positions are known (there in reality unobserable) $\\tilde{\\beta}$ can be calculated geometrically, let $\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}$ denote the geometrically obtained scattering angle. This may be estimated by measured values of the deposed energies and incident energy of the incident photon by $$ \\cos(\\beta) = 1 - \\frac{m_e c^2E_1}{E_0(E_0-E_1)} $$ with $m_ec^2$ begin the mass energy of the electron.\nInserting these probabilities and integrating results in $$ \\begin{aligned} p_{Y:X}(y:x,E_0) =\u0026amp; \\int p_{Y:\\tilde{Y}}(y:\\tilde{y},E_0)p_{\\tilde{Y}:X}(\\tilde{y}:x,E_0)\\textrm{d}\\tilde{y}\\\\ =\u0026amp;\\int_{\\mathbb{R}^3}\\frac{\\cos(\\theta_{\\tilde{V}_1M})}{\\tilde{V}_1M^2}p_{V_1:\\tilde{V}_1}(V_1:\\tilde{V_1},E_0)\\\\ \\times \u0026amp; \\int_{\\mathbb{R}^3}\\frac{\\cos(\\theta_{\\tilde{V}_1\\tilde{V}_2})}{\\tilde{V}_1\\tilde{V}_2}p_{V_2:\\tilde{V}_2}(V_2:\\tilde{V}_2,E_0)\\\\ \\times \u0026amp; K(\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}:E_0)p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M},E_0)\\textrm{d}\\tilde{V}_2\\textrm{d}\\tilde{V}_1 \\end{aligned} $$\nWe will assume that the uncertainty on the direction of the Compton cone axis may be considered as negligible compared to the uncertainty of the measured Compton scattering angle. Consequently, the real and measured points where $\\mathfrak{p}$ hits the detector may be merged, leading to the simplified formulation: $$ p_{Y:X}(y:x,E_0) =\\frac{\\cos(\\theta_{{V}_1M})}{{V}_1M^2}\\frac{\\cos(\\theta_{{V}_1{V}_2})}{{V}_1{V}_2}K(\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}:E_0)p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M},E_0) $$\nThe element $t_{ij}$ of the system matrix $T$ is defined as:\nWith the expression for $p_{Y_i:X}(y_i:x,E_0)$ we get $$ t_{ij}= \\frac{1}{\\textrm{vol}(v_j)}\\frac{\\cos(\\theta_{{V}_1{V}_2})}{{V}_1{V}_2}\\int_{v_j} \\frac{\\cos(\\theta_{{V}_1M})}{{V}_1M^2}K(\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}:E_0)p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M},E_0)\\textrm{d}x $$\nThe only remaining thing is to model the probability $p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M},E_0)$, which describes the uncertainty of the measurement of the scattering angle, $\\beta$. For an ideal detector this probability would be $$ p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M},E_0) = \\delta(\\beta-\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}). $$ For a finite resolution detector, a convenient choice may be the Gaussian distribution with mean $\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}$ and standard deviation $\\sigma_{\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}}$, $$ p_{\\beta:\\tilde{\\beta}}(\\beta:\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M},E_0) = \\frac{1}{\\sigma_{\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}} \\sqrt{2\\pi}}\\exp\\left[\\frac{(\\beta-\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M})^2}{2\\sigma^2_{\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}}}\\right]. $$ The unknown mean $\\tilde{\\beta}_{\\tilde{V}_1,\\tilde{V}_2,M}$ may be replaced by the measured value $\\beta$. The standard deviation can be calculated frm the knwn detector uncertainties $\\sigma_{\\tilde{E}_1}$ and $\\sigma_{\\tilde{E}_2}$ as: $$ \\sigma_{\\tilde{\\beta}} = \\frac{m_ec^2}{E_0^2\\sin(\\tilde{\\beta})}\\sqrt{\\sigma_{\\tilde{E}_1}^2+\\frac{\\tilde{E}_1^2(\\tilde{E}_2+E_0)^2}{\\tilde{E}_2^4}\\sigma_{\\tilde{E}_2}^2} $$\nIt may be seen from the iterative equation above that the factor multiplying the integral in the equation for the system matrix element gets canceled in the iterative reconstruction process and may thus be ignored.\n","permalink":"https://plundhammar.github.io/posts/image_reconstruction_by_lm-mlem_analytical_method/","summary":"Litterature: Mainly based on:\nVoichita Maxim et al (2016) Probabilistic models and numerical calculation of system matrix and sensitivity in list-mode MLEM 3D reconstruction of Compton camera images Phys.Med.Biol. 61 243\nUncertainty distribution in measurements\nOrdonez et al (1997) Ordonez C E, Bolozdynya A and Chang W 1997 Dependence of angular uncertainties on the energy resolution of Compton cameras IEEE Nuclear Science Symp. vol 2\nLM-MLEM\nWilderman et al (1998) Wilderman S J, Clinthorne N, Fessler J A and Rogers W L 1998a List-mode maximum likelihood reconstruction of Compton scatter camera images in nuclear medicine Nuclear Science Symp.","title":"Image reconstruction by LM-MLEM"}]